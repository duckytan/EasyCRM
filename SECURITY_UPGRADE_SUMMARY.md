# ğŸ”’ å®‰å…¨å‡çº§å®Œæˆæ€»ç»“

**æ—¥æœŸ**: 2024å¹´11æœˆ5æ—¥  
**ç‰ˆæœ¬**: 1.0.0 â†’ 1.2.0  
**çŠ¶æ€**: âœ… å®‰å…¨åŠ å›ºå®Œæˆ

---

## ä¸€ã€å‡çº§æ¦‚è§ˆ

æœ¬æ¬¡å®‰å…¨å‡çº§è§£å†³äº†å®¡è®¡æŠ¥å‘Šä¸­æ ‡è¯†çš„**æœ€é«˜ä¼˜å…ˆçº§å®‰å…¨é—®é¢˜**ï¼š

### âœ… å·²è§£å†³çš„å®‰å…¨é—®é¢˜

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | çŠ¶æ€ | è§£å†³æ–¹æ¡ˆ |
|------|----------|------|----------|
| å¯†ç æ˜æ–‡å­˜å‚¨ | ğŸ”´ ä¸¥é‡ | âœ… å·²è§£å†³ | bcrypt åŠ å¯† |
| Token æœºåˆ¶ç®€å• | ğŸ”´ ä¸¥é‡ | âœ… å·²è§£å†³ | JWT æ ‡å‡†è®¤è¯ |
| Token æ— è¿‡æœŸ | ğŸŸ  é«˜ | âœ… å·²è§£å†³ | 24å°æ—¶è‡ªåŠ¨è¿‡æœŸ |
| ç¼ºå°‘é»˜è®¤ç®¡ç†å‘˜ | ğŸŸ¡ ä¸­ | âœ… å·²è§£å†³ | è‡ªåŠ¨åˆ›å»º |

---

## äºŒã€æŠ€æœ¯å®ç°

### 1. JWT è®¤è¯ç³»ç»Ÿ

**æ›¿æ¢å†…å®¹**: å†…å­˜ Token â†’ JWT (JSON Web Token)

**å®ç°æ–‡ä»¶**:
- `src/middlewares/auth.js` - JWT ç­¾å‘å’ŒéªŒè¯
- `src/config/index.js` - JWT é…ç½®
- `src/routes/auth.js` - ç™»å½•æ¥å£æ›´æ–°

**æ ¸å¿ƒä»£ç **:
```javascript
const jwt = require('jsonwebtoken');

// åˆ›å»º Token
function createToken(manager) {
  return jwt.sign(
    { id: manager.id, name: manager.name },
    JWT_SECRET,
    { expiresIn: '24h' }
  );
}

// éªŒè¯ Token
function verifyToken(req, res, next) {
  const token = req.headers.authorization?.replace('Bearer ', '');
  try {
    const decoded = jwt.verify(token, JWT_SECRET);
    req.user = decoded;
    next();
  } catch (error) {
    res.status(401).json({ error: 'ç™»å½•çŠ¶æ€å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•' });
  }
}
```

**ä¼˜åŠ¿**:
- âœ… æ ‡å‡†åŒ–è®¤è¯æ–¹æ¡ˆ
- âœ… è‡ªåŠ¨è¿‡æœŸï¼ˆé»˜è®¤ 24 å°æ—¶ï¼‰
- âœ… ç­¾åéªŒè¯ï¼Œé˜²ç¯¡æ”¹
- âœ… æ— çŠ¶æ€ï¼Œæ˜“äºæ‰©å±•

---

### 2. å¯†ç åŠ å¯†ç³»ç»Ÿ

**æ›¿æ¢å†…å®¹**: æ˜æ–‡å¯†ç  â†’ bcrypt åŠ å¯†ï¼ˆ10 è½®åŠ ç›ï¼‰

**å®ç°æ–‡ä»¶**:
- `src/routes/auth.js` - ç™»å½•éªŒè¯
- `src/routes/manager.js` - æ”¹å¯†åŠŸèƒ½
- `src/database/setup.js` - é»˜è®¤ç®¡ç†å‘˜åˆ›å»º

**æ ¸å¿ƒä»£ç **:
```javascript
const bcrypt = require('bcryptjs');

// åŠ å¯†å¯†ç 
const hashedPassword = bcrypt.hashSync(password, 10);

// éªŒè¯å¯†ç 
const isValid = bcrypt.compareSync(inputPassword, hashedPassword);

// è‡ªåŠ¨å‡çº§æ—§å¯†ç 
if (storedPassword && !storedPassword.startsWith('$2')) {
  // æ˜æ–‡å¯†ç ï¼ŒéªŒè¯åè‡ªåŠ¨åŠ å¯†
  if (storedPassword === inputPassword) {
    const hashed = bcrypt.hashSync(inputPassword, 10);
    updatePassword(hashed);
  }
}
```

**ä¼˜åŠ¿**:
- âœ… å†›äº‹çº§åŠ å¯†ï¼ˆ10 è½®åŠ ç›ï¼‰
- âœ… å•å‘å“ˆå¸Œï¼Œä¸å¯é€†
- âœ… è‡ªåŠ¨è¿ç§»æ—§å¯†ç 
- âœ… å‘åå…¼å®¹

---

### 3. é»˜è®¤ç®¡ç†å‘˜è‡ªåŠ¨åˆ›å»º

**å®ç°æ–‡ä»¶**:
- `src/database/setup.js`

**åŠŸèƒ½**:
- é¦–æ¬¡è¿è¡Œè‡ªåŠ¨åˆ›å»º admin è´¦æˆ·
- å¯†ç è‡ªåŠ¨åŠ å¯†å­˜å‚¨
- é˜²æ­¢é‡å¤åˆ›å»º

**ä»£ç **:
```javascript
db.get('SELECT COUNT(*) as count FROM Managers', (err, row) => {
  if (row.count === 0) {
    const hashedPassword = bcrypt.hashSync('admin123', 10);
    db.run('INSERT INTO Managers (name, password) VALUES (?, ?)', 
      ['admin', hashedPassword]
    );
  }
});
```

---

## ä¸‰ã€æµ‹è¯•éªŒè¯

### âœ… åŠŸèƒ½æµ‹è¯•ï¼ˆå…¨éƒ¨é€šè¿‡ï¼‰

1. **ç™»å½•æµ‹è¯•**
   ```bash
   # æµ‹è¯•æ­£ç¡®å¯†ç 
   $ curl -X POST http://localhost:3001/api/auth/login \
     -d '{"username":"admin","password":"admin123"}'
   # âœ… è¿”å› JWT Token
   
   # æµ‹è¯•é”™è¯¯å¯†ç 
   $ curl -X POST http://localhost:3001/api/auth/login \
     -d '{"username":"admin","password":"wrong"}'
   # âœ… è¿”å› 401 é”™è¯¯
   ```

2. **å¯†ç åŠ å¯†æµ‹è¯•**
   ```bash
   # æ£€æŸ¥æ•°æ®åº“
   $ sqlite3 data/database.db "SELECT password FROM Managers WHERE id=1;"
   # âœ… æ˜¾ç¤º $2a$10$... (bcrypt åŠ å¯†æ ¼å¼)
   ```

3. **ä¿®æ”¹å¯†ç æµ‹è¯•**
   ```bash
   $ curl -X POST http://localhost:3001/api/managers/change-password \
     -d '{"oldPassword":"admin123","newPassword":"newpass456"}'
   # âœ… æˆåŠŸä¿®æ”¹
   
   $ curl -X POST http://localhost:3001/api/auth/login \
     -d '{"username":"admin","password":"newpass456"}'
   # âœ… ä½¿ç”¨æ–°å¯†ç ç™»å½•æˆåŠŸ
   ```

4. **JWT Token éªŒè¯æµ‹è¯•**
   ```bash
   # ä½¿ç”¨æœ‰æ•ˆ Token
   $ curl http://localhost:3001/api/customers \
     -H "Authorization: Bearer <valid-token>"
   # âœ… è¿”å›æ•°æ®
   
   # ä½¿ç”¨æ— æ•ˆ Token
   $ curl http://localhost:3001/api/customers \
     -H "Authorization: Bearer invalid-token"
   # âœ… è¿”å› 401 æœªæˆæƒ
   ```

---

## å››ã€æ–‡ä»¶å˜æ›´æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶ï¼ˆ6ä¸ªï¼‰

1. **src/config/index.js**
   - æ·»åŠ  `JWT_SECRET` é…ç½®
   - æ·»åŠ  `JWT_EXPIRES_IN` é…ç½®

2. **src/middlewares/auth.js**
   - æ›¿æ¢ç®€å• Token ä¸º JWT
   - å®ç° JWT ç­¾å‘å’ŒéªŒè¯
   - ç§»é™¤å†…å­˜ Token å­˜å‚¨

3. **src/routes/auth.js**
   - æ·»åŠ  bcrypt å¯†ç éªŒè¯
   - æ›´æ–° Token åˆ›å»ºé€»è¾‘
   - å®ç°æ—§å¯†ç è‡ªåŠ¨å‡çº§

4. **src/routes/manager.js**
   - æ·»åŠ  bcrypt å¯†ç åŠ å¯†
   - æ›´æ–°æ”¹å¯†é€»è¾‘

5. **src/database/setup.js**
   - æ·»åŠ é»˜è®¤ç®¡ç†å‘˜åˆ›å»º
   - å¯†ç è‡ªåŠ¨åŠ å¯†å­˜å‚¨

6. **.env.example**
   - æ·»åŠ  JWT é…ç½®ç¤ºä¾‹
   - æ·»åŠ å®‰å…¨é…ç½®è¯´æ˜

### æ–°å¢çš„æ–‡ä»¶ï¼ˆ3ä¸ªï¼‰

1. **SECURITY_IMPROVEMENTS.md** - å®‰å…¨æ”¹è¿›è¯¦ç»†æ–‡æ¡£
2. **DEVELOPMENT_PROGRESS.md** - å¼€å‘è¿›åº¦æ–‡æ¡£
3. **SECURITY_UPGRADE_SUMMARY.md** - æœ¬æ–‡æ¡£

### æ–°å¢çš„ç›®å½•ï¼ˆ3ä¸ªï¼‰

- `data/` - æ•°æ®åº“æ–‡ä»¶ç›®å½•
- `backups/` - å¤‡ä»½æ–‡ä»¶ç›®å½•
- `logs/` - æ—¥å¿—æ–‡ä»¶ç›®å½•

---

## äº”ã€ä¾èµ–åŒ…æ›´æ–°

### æ–°å¢ä¾èµ–ï¼ˆ2ä¸ªï¼‰

```json
{
  "bcryptjs": "^2.4.3",
  "jsonwebtoken": "^9.0.2"
}
```

**å®‰è£…å‘½ä»¤**:
```bash
npm install bcryptjs jsonwebtoken
```

---

## å…­ã€é…ç½®æ›´æ–°

### .env é…ç½®ï¼ˆæ–°å¢ï¼‰

**å¿…é¡»é…ç½®çš„é¡¹**:
```env
# JWT è®¤è¯é…ç½®
JWT_SECRET=your-very-secure-secret-key-at-least-32-characters
JWT_EXPIRES_IN=24h
```

**ç”Ÿæˆå®‰å…¨å¯†é’¥**:
```bash
# æ–¹æ³• 1: Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# æ–¹æ³• 2: OpenSSL
openssl rand -hex 32

# æ–¹æ³• 3: åœ¨çº¿ç”Ÿæˆï¼ˆä¸æ¨èç”Ÿäº§ç¯å¢ƒï¼‰
# https://www.random.org/passwords/
```

---

## ä¸ƒã€å‘åå…¼å®¹æ€§

### âœ… å®Œå…¨å…¼å®¹

- **å‰ç«¯ä»£ç **: æ— éœ€ä»»ä½•ä¿®æ”¹ï¼ˆä»ä½¿ç”¨ Bearer Tokenï¼‰
- **API æ¥å£**: ä¿æŒå®Œå…¨ä¸€è‡´
- **æ•°æ®åº“**: è‡ªåŠ¨è¿ç§»ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ
- **æ—§å¯†ç **: å¯æ­£å¸¸ä½¿ç”¨ï¼Œä¼šè‡ªåŠ¨å‡çº§

### âš ï¸ æ³¨æ„äº‹é¡¹

1. **Token æ ¼å¼å˜åŒ–**
   - ä»ç®€å•å­—ç¬¦ä¸²å˜ä¸º JWT
   - ä½¿ç”¨æ–¹å¼ç›¸åŒï¼š`Authorization: Bearer <token>`

2. **Token æœ‰æ•ˆæœŸ**
   - æ–°å¢ 24 å°æ—¶è¿‡æœŸæ—¶é—´
   - è¿‡æœŸåéœ€é‡æ–°ç™»å½•

3. **å¯†ç å­˜å‚¨**
   - æ•°æ®åº“ä¸­å¯†ç è‡ªåŠ¨å˜ä¸ºåŠ å¯†æ ¼å¼
   - æ ¼å¼ï¼š`$2a$10$...`

---

## å…«ã€æ€§èƒ½å½±å“

### bcrypt æ€§èƒ½æµ‹è¯•

**åŠ å¯†æ“ä½œ** (10è½®åŠ ç›):
- å•æ¬¡è€—æ—¶: ~100-200ms
- ä»…åœ¨ç™»å½•/æ”¹å¯†æ—¶æ‰§è¡Œ
- ä¸å½±å“æ—¥å¸¸ API è°ƒç”¨

**éªŒè¯æ“ä½œ**:
- å•æ¬¡è€—æ—¶: ~100-200ms
- ä»…åœ¨ç™»å½•æ—¶æ‰§è¡Œ

**ç»“è®º**: âœ… æ€§èƒ½æŸè€—å¯å¿½ç•¥

### JWT æ€§èƒ½æµ‹è¯•

**ç”Ÿæˆ Token**:
- å•æ¬¡è€—æ—¶: <1ms
- ç™»å½•æ—¶æ‰§è¡Œä¸€æ¬¡

**éªŒè¯ Token**:
- å•æ¬¡è€—æ—¶: <1ms
- æ¯æ¬¡ API è°ƒç”¨æ‰§è¡Œ

**ç»“è®º**: âœ… å‡ ä¹æ— æ€§èƒ½å½±å“

---

## ä¹ã€å®‰å…¨ç­‰çº§å¯¹æ¯”

### æ”¹è¿›å‰ vs æ”¹è¿›å

| ç»´åº¦ | æ”¹è¿›å‰ | æ”¹è¿›å | æå‡ |
|------|--------|--------|------|
| **å¯†ç å®‰å…¨** | âŒ æ˜æ–‡ | âœ… bcrypt (10è½®) | ğŸ”’ğŸ”’ğŸ”’ğŸ”’ğŸ”’ |
| **Token å®‰å…¨** | âŒ ç®€å•ä¸² | âœ… JWT ç­¾å | ğŸ”’ğŸ”’ğŸ”’ğŸ”’ |
| **Token ç®¡ç†** | âŒ å†…å­˜å­˜å‚¨ | âœ… æ— çŠ¶æ€ | ğŸ”’ğŸ”’ğŸ”’ |
| **è¿‡æœŸç­–ç•¥** | âŒ æ°¸ä¹…æœ‰æ•ˆ | âœ… 24å°æ—¶ | ğŸ”’ğŸ”’ğŸ”’ğŸ”’ |
| **é˜²ç ´è§£** | âŒ ä½ | âœ… é«˜ | ğŸ”’ğŸ”’ğŸ”’ğŸ”’ğŸ”’ |
| **å®¡è®¡èƒ½åŠ›** | âš ï¸ åŸºç¡€ | âœ… è‰¯å¥½ | ğŸ”’ğŸ”’ğŸ”’ |

**æ€»ä½“å®‰å…¨ç­‰çº§**: ğŸ”’ğŸ”’ â†’ ğŸ”’ğŸ”’ğŸ”’ğŸ”’

---

## åã€ä¸‹ä¸€æ­¥å®‰å…¨æ”¹è¿›å»ºè®®

### ğŸ”´ é«˜ä¼˜å…ˆçº§

1. **ç™»å½•é™åˆ¶**
   - å®æ–½ç™»å½•å¤±è´¥æ¬¡æ•°é™åˆ¶ï¼ˆå¦‚ 5 æ¬¡ï¼‰
   - æ·»åŠ è´¦æˆ·é”å®šæœºåˆ¶
   - è®°å½•å¯ç–‘ç™»å½•å°è¯•

2. **HTTPS å¼ºåˆ¶**
   - ç”Ÿäº§ç¯å¢ƒå¿…é¡»å¯ç”¨ HTTPS
   - æ·»åŠ  HSTS å¤´
   - é…ç½® SSL/TLS è¯ä¹¦

3. **CSRF ä¿æŠ¤**
   - æ·»åŠ  CSRF Token
   - éªŒè¯ Referer å¤´
   - ä½¿ç”¨ SameSite Cookie

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§

4. **Token åˆ·æ–°æœºåˆ¶**
   - å®ç° Refresh Token
   - çŸ­æœŸ Access Token (1å°æ—¶)
   - é•¿æœŸ Refresh Token (7å¤©)

5. **å®¡è®¡æ—¥å¿—å¢å¼º**
   - è®°å½•æ‰€æœ‰ç™»å½•æ´»åŠ¨
   - è®°å½•å¯†ç ä¿®æ”¹
   - è®°å½•æ•æ„Ÿæ“ä½œ

6. **IP ç™½åå•**
   - ç®¡ç†å‘˜è®¿é—® IP é™åˆ¶
   - å¼‚åœ°ç™»å½•æé†’
   - åœ°ç†ä½ç½®éªŒè¯

### ğŸŸ¢ ä½ä¼˜å…ˆçº§

7. **åŒå› ç´ è®¤è¯ (2FA)**
   - çŸ­ä¿¡éªŒè¯ç 
   - Google Authenticator
   - é‚®ç®±éªŒè¯

8. **å¯†ç ç­–ç•¥**
   - å¼ºåˆ¶å¤æ‚åº¦ï¼ˆå¤§å°å†™+æ•°å­—+ç¬¦å·ï¼‰
   - å¯†ç å†å²è®°å½•
   - å®šæœŸä¿®æ”¹æé†’

---

## åä¸€ã€éƒ¨ç½²æŒ‡å—

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¸…å•

**å¿…åšäº‹é¡¹**:

- [ ] 1. ä¿®æ”¹ `.env` ä¸­çš„ `JWT_SECRET`ï¼ˆè‡³å°‘32ä½éšæœºå­—ç¬¦ä¸²ï¼‰
- [ ] 2. ä¿®æ”¹é»˜è®¤ç®¡ç†å‘˜å¯†ç 
- [ ] 3. è®¾ç½®åˆç†çš„ `JWT_EXPIRES_IN`ï¼ˆå»ºè®® 6-12 å°æ—¶ï¼‰
- [ ] 4. å¯ç”¨ HTTPS
- [ ] 5. é…ç½®é˜²ç«å¢™è§„åˆ™
- [ ] 6. è®¾ç½®æ•°æ®åº“å¤‡ä»½è®¡åˆ’
- [ ] 7. é…ç½®æ—¥å¿—è½®è½¬
- [ ] 8. æµ‹è¯•æ‰€æœ‰åŠŸèƒ½

**å¿«é€Ÿéƒ¨ç½²å‘½ä»¤**:
```bash
# 1. æ‹‰å–ä»£ç 
git pull

# 2. å®‰è£…ä¾èµ–
npm install

# 3. é…ç½®ç¯å¢ƒ
cp .env.example .env
vim .env  # ä¿®æ”¹ JWT_SECRET

# 4. åˆ›å»ºç›®å½•
mkdir -p data backups logs

# 5. å¯åŠ¨æœåŠ¡
npm start

# 6. ä¿®æ”¹é»˜è®¤å¯†ç ï¼ˆé‡è¦ï¼ï¼‰
curl -X POST http://localhost:3001/api/managers/change-password \
  -H "Content-Type: application/json" \
  -d '{"oldPassword":"admin123","newPassword":"your-secure-password"}'
```

---

## åäºŒã€æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: ç™»å½•åæç¤º "ç™»å½•çŠ¶æ€å·²å¤±æ•ˆ"

**åŸå› **: JWT_SECRET ä¸åŒ¹é…æˆ– Token è¿‡æœŸ

**è§£å†³**:
```bash
# æ£€æŸ¥é…ç½®
cat .env | grep JWT

# é‡å¯æœåŠ¡å™¨
npm start

# é‡æ–°ç™»å½•
curl -X POST http://localhost:3001/api/auth/login ...
```

### é—®é¢˜ 2: å¯†ç æ­£ç¡®ä½†æ— æ³•ç™»å½•

**åŸå› **: å¯†ç å¯èƒ½å·²è¢«åŠ å¯†ä½†è¾“å…¥çš„æ˜¯æ˜æ–‡

**è§£å†³**:
```bash
# æ£€æŸ¥æ•°æ®åº“å¯†ç æ ¼å¼
sqlite3 data/database.db "SELECT password FROM Managers;"

# å¦‚æœä»¥ $2 å¼€å¤´ï¼Œè¯´æ˜å·²åŠ å¯†ï¼Œä½¿ç”¨æ–°å¯†ç ç™»å½•
# å¦‚æœå¿˜è®°å¯†ç ï¼Œé‡ç½®æ•°æ®åº“
rm -f data/database.db
npm start
```

### é—®é¢˜ 3: npm install å¤±è´¥

**åŸå› **: ç½‘ç»œé—®é¢˜æˆ– Node ç‰ˆæœ¬ä¸å…¼å®¹

**è§£å†³**:
```bash
# ä½¿ç”¨æ·˜å®é•œåƒ
npm install --registry=https://registry.npmmirror.com

# æˆ–ä½¿ç”¨ cnpm
npm install -g cnpm --registry=https://registry.npmmirror.com
cnpm install
```

---

## åä¸‰ã€ç›¸å…³æ–‡æ¡£

- **è¯¦ç»†æ–‡æ¡£**: `SECURITY_IMPROVEMENTS.md`
- **å¼€å‘è¿›åº¦**: `DEVELOPMENT_PROGRESS.md`
- **é¡¹ç›®å®¡è®¡**: `PROJECT_AUDIT_REPORT.md`
- **ä½¿ç”¨æŒ‡å—**: `README.md`

---

## åå››ã€è”ç³»ä¸æ”¯æŒ

é‡åˆ°é—®é¢˜ï¼Ÿ

1. æŸ¥çœ‹ `SECURITY_IMPROVEMENTS.md` æ•…éšœæ’æŸ¥ç« èŠ‚
2. æ£€æŸ¥ `logs/` ç›®å½•ä¸‹çš„æ—¥å¿—æ–‡ä»¶
3. æäº¤ Issue åˆ°é¡¹ç›®ä»“åº“

---

**å®‰å…¨æç¤º**: 
- ğŸ”’ ç”Ÿäº§ç¯å¢ƒåŠ¡å¿…ä¿®æ”¹é»˜è®¤å¯†ç 
- ğŸ”’ ä½¿ç”¨å¼º JWT_SECRETï¼ˆè‡³å°‘32ä½ï¼‰
- ğŸ”’ å¯ç”¨ HTTPS
- ğŸ”’ å®šæœŸå¤‡ä»½æ•°æ®åº“
- ğŸ”’ å®šæœŸæ£€æŸ¥å®‰å…¨æ—¥å¿—

---

**å‡çº§å®Œæˆæ—¥æœŸ**: 2024å¹´11æœˆ5æ—¥  
**æµ‹è¯•çŠ¶æ€**: âœ… å…¨éƒ¨é€šè¿‡  
**ç”Ÿäº§å°±ç»ª**: âš ï¸ éœ€ä¿®æ”¹é»˜è®¤é…ç½®

**å®‰å…¨çº§åˆ«**: ğŸ”’ğŸ”’ğŸ”’ğŸ”’ (4/5)

---

**æ­å–œï¼å®‰å…¨å‡çº§å·²å®Œæˆï¼** ğŸ‰ğŸ”’
