<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>编辑客户 - 客户信息管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="../css/common.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3b82f6;
            --secondary-color: #93c5fd;
            --danger-color: #ff3b30;
            --text-color: #333;
            --border-color: #e5e7eb;
            --bg-light: #f8fafc;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-color);
        }
        
        .avatar-upload {
            position: relative;
            width: 100px;
            height: 100px;
            margin: 0 auto;
            transition: transform 0.3s;
        }
        
        .avatar-upload:hover {
            transform: scale(1.05);
        }
        
        .avatar-upload img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--border-color);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .avatar-edit {
            position: absolute;
            right: 5px;
            bottom: 5px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #3b82f6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }
        
        .section-header {
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 8px;
        }
        
        .section-header i {
            margin-right: 8px;
            color: var(--primary-color);
            font-size: 1.1em;
        }
        
        .form-section {
            margin-bottom: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .form-section:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        /* 桌面端响应式布局 */
        @media (min-width: 768px) {
            body {
                background-color: #f0f2f5;
                padding: 0;
                margin: 0;
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: flex-start;
            }
            
            .ios-page-container {
                max-width: 768px;
                width: 100%;
                margin: 0 auto;
                box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
                min-height: 100vh;
                overflow-y: auto;
                background-color: white;
                position: relative;
                display: flex;
                flex-direction: column;
            }
            
            .main-content {
                padding-top: 86px;
                padding-left: 20px;
                padding-right: 20px;
                padding-bottom: 50px;
                flex: 1;
                width: 100%;
                box-sizing: border-box;
            }
            
            .ios-status-bar, .ios-title-bar {
                width: 100%;
                max-width: 768px;
                left: 50%;
                transform: translateX(-50%);
                box-sizing: border-box;
                position: fixed;
            }
            
            .avatar-upload {
                margin-top: 10px;
            }
            
            .form-section {
                border: 1px solid rgba(0, 0, 0, 0.05);
                margin-left: auto;
                margin-right: auto;
                box-shadow: 0 2px 10px rgba(0,0,0,0.05);
                transition: all 0.3s ease;
            }
            
            .form-section:hover {
                transform: translateY(-2px);
            }
            
            /* 桌面端按钮样式优化 */
            .ios-button-primary, .ios-button-danger {
                cursor: pointer;
            }
            
            /* 按钮区域宽度控制 */
            .flex.flex-col.items-center.mb-24.px-4 {
                max-width: 600px;
                margin-left: auto;
                margin-right: auto;
            }
        }
        
        /* 基础移动端样式 */
        .main-content {
            padding-top: 86px;
            max-width: 100%;
            overflow-x: hidden;
        }
        
        /* 固定标题栏，位于状态栏下方 */
        .ios-title-bar {
            position: fixed;
            top: 36px; /* 状态栏高度 */
            left: 0;
            right: 0;
            z-index: 1000;
            display: grid;
            grid-template-columns: 60px 1fr 60px; /* 左侧、标题、右侧 */
            background-color: white;
            padding: 12px 16px;
            font-size: 17px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            align-items: center;
            box-sizing: border-box;
        }
        
        .title-bar-title {
            font-weight: 600;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 17px;
            color: #000;
        }
        
        .title-bar-left, .title-bar-right {
            z-index: 2;
        }
        
        .title-bar-left {
            text-align: left;
        }
        
        .title-bar-right {
            text-align: right;
        }
        
        /* 美化输入框 */
        .ios-form-input, select, textarea {
            border-radius: 8px !important;
            border: 1px solid var(--border-color) !important;
            padding: 12px !important;
            width: 100%;
            transition: border-color 0.3s, box-shadow 0.3s;
            background-color: white;
        }
        
        .ios-form-input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2) !important;
            outline: none;
        }
        
        /* 美化标签 */
        .ios-form-label {
            font-weight: 500;
            margin-bottom: 6px;
            display: block;
            color: #4b5563;
        }
        
        /* 美化按钮 */
        .ios-button-primary {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.2s;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .ios-button-primary:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
        }
        
        .ios-button-primary:active {
            transform: translateY(1px);
        }
        
        .ios-button-danger {
            background-color: var(--danger-color);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .ios-button-danger:hover {
            background-color: #e02d26;
            transform: translateY(-1px);
        }
        
        .ios-button-danger:active {
            background-color: #d63530;
            transform: translateY(1px);
        }
        
        /* 确认删除对话框样式 */
        .delete-confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.2s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .delete-confirm-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            width: 85%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            animation: scaleIn 0.2s ease-out;
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .delete-confirm-title {
            font-weight: 700;
            font-size: 20px;
            margin-bottom: 16px;
            text-align: center;
            color: var(--danger-color);
        }
        
        .delete-confirm-message {
            margin-bottom: 24px;
            text-align: center;
            color: #666;
            line-height: 1.5;
        }
        
        .delete-confirm-buttons {
            display: flex;
            justify-content: space-between;
        }
        
        .delete-confirm-cancel {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            background: #f5f5f5;
            border-radius: 10px;
            margin-right: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .delete-confirm-cancel:hover {
            background: #ebebeb;
            border-color: #ccc;
        }
        
        .delete-confirm-delete {
            flex: 1;
            padding: 12px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .delete-confirm-delete:hover {
            background: #e02d26;
            transform: translateY(-1px);
        }
        
        /* Toast提示样式 */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            max-width: 90%;
            text-align: center;
            z-index: 2000;
            opacity: 0;
            transition: transform 0.3s, opacity 0.3s;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        .toast-success {
            background-color: rgba(52, 199, 89, 0.9);
        }
        
        .toast-error {
            background-color: rgba(255, 59, 48, 0.9);
        }
        
        .toast-warning {
            background-color: rgba(255, 149, 0, 0.9);
        }
        
        .toast-info {
            background-color: rgba(0, 122, 255, 0.9);
        }
        
        /* 状态栏固定 */
        .ios-status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: white;
            z-index: 1001;
            padding: 6px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 24px;
        }
        
        .status-bar-time {
            font-weight: 500;
        }
        
        .status-bar-icons {
            display: flex;
            gap: 8px;
        }
        
        /* 修复桌面端显示错位问题 */
        @media screen and (min-width: 1024px) {
            body {
                margin: 0;
                padding: 0;
                display: flex;
                justify-content: center;
                background-color: #f0f2f5;
            }
            
            .ios-page-container {
                width: 100%;
                max-width: 768px;
                margin: 0 auto;
                overflow-y: auto;
                box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
                background: white;
            }
            
            .ios-status-bar, .ios-title-bar {
                max-width: 768px;
                width: 100%;
                left: 50%;
                transform: translateX(-50%);
            }
            
            .ios-title-bar {
                top: 36px;
            }
            
            .main-content {
                padding-top: 86px;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            /* 客户卡片在桌面端的优化 */
            .customer-card {
                max-width: 100%;
                margin: 16px auto;
            }
            
            .avatar-container {
                width: 120px;
                height: 120px;
                margin: 20px auto;
            }
            
            .customer-form-container {
                padding: 0 20px;
            }
            
            .customer-action-buttons {
                margin-bottom: 20px;
            }
        }
    </style>
    <link rel="stylesheet" href="../css/fixes.css">
</head>
<body>
    <div class="ios-page-container">
        <!-- 状态栏（隐藏） -->
        <div class="ios-status-bar" style="display: none;"></div>
        
        <!-- 标题栏 -->
        <div class="ios-title-bar">
            <div class="title-bar-left">
                <a href="javascript:history.back()" class="text-blue-500">
                    取消
                </a>
            </div>
            <div class="title-bar-title">编辑客户</div>
            <div class="title-bar-right">
                <a href="#" id="headerSaveBtn" class="text-blue-500 font-semibold">
                    保存
                </a>
            </div>
        </div>
        
        <!-- 主内容区域 -->
        <div class="main-content pb-20">
            <!-- 头像上传区域 -->
            <div class="bg-white p-6 rounded-md mb-6 text-center">
                <div class="avatar-upload">
                    <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="客户头像">
                    <div class="avatar-edit">
                        <i class="fas fa-camera"></i>
                    </div>
                </div>
                <div class="mt-3 text-sm text-gray-500">点击更换头像</div>
            </div>
            
            <!-- 基本信息部分 -->
            <div class="form-section bg-white p-4 rounded-md mb-6">
                <div class="section-header">
                    <i class="fas fa-user"></i> 基本信息
                </div>
                
                <div class="ios-form-group">
                    <label class="ios-form-label">姓名 <span class="text-red-500">*</span></label>
                    <input type="text" class="ios-form-input">
                </div>
                
                <div class="ios-form-group">
                    <label class="ios-form-label">性别</label>
                    <div class="flex space-x-4 mt-2">
                        <label class="flex items-center">
                            <input type="radio" name="gender" class="mr-2">
                            <span>男</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="gender" class="mr-2">
                            <span>女</span>
                        </label>
                    </div>
                </div>
                
                <div class="ios-form-group">
                    <label class="ios-form-label">年龄</label>
                    <input type="number" class="ios-form-input">
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="category">
                        客户分类
                    </label>
                    <div class="relative">
                        <select id="category" name="category" class="block appearance-none w-full bg-white border border-gray-300 hover:border-gray-400 px-4 py-2 pr-8 rounded shadow leading-tight focus:outline-none focus:border-blue-500">
                            <option value="">请选择客户分类</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>
                    <p class="text-sm text-gray-500 mt-1" id="category-description"></p>
                </div>
                
                <div class="ios-form-group mt-4">
                    <label class="ios-form-label">注册日期 <span class="text-red-500">*</span></label>
                    <input type="date" class="ios-form-input">
                </div>
            </div>
            
            <!-- 联系方式部分 -->
            <div class="form-section bg-white p-4 rounded-md mb-6">
                <div class="section-header">
                    <i class="fas fa-phone-alt"></i> 联系方式
                </div>
                
                <div class="ios-form-group">
                    <label class="ios-form-label">手机号码 <span class="text-red-500">*</span></label>
                    <input type="tel" class="ios-form-input">
                </div>
                
                <div class="ios-form-group">
                    <label class="ios-form-label">电子邮箱</label>
                    <input type="email" class="ios-form-input">
                </div>
                
                <div class="ios-form-group mb-0">
                    <label class="ios-form-label">微信号</label>
                    <input type="text" class="ios-form-input">
                </div>
            </div>
            
            <!-- 地址信息部分 -->
            <div class="form-section bg-white p-4 rounded-md mb-6">
                <div class="section-header">
                    <i class="fas fa-map-marker-alt"></i> 地址信息
                </div>
                
                <div class="ios-form-group">
                    <label class="ios-form-label">所在地区</label>
                    <select id="region" class="ios-form-input">
                        <option value="">请选择地区</option>
                        <option value="上海">上海</option>
                        <option value="北京">北京</option>
                        <option value="广州">广州</option>
                        <option value="深圳">深圳</option>
                        <option value="其他">其他</option>
                    </select>
                    <p class="text-sm text-gray-500 mt-1" id="region-description"></p>
                </div>
                
                <div class="ios-form-group mb-0">
                    <label class="ios-form-label">详细地址</label>
                    <input type="text" class="ios-form-input">
                </div>
            </div>
            
            <!-- 客户需求部分 -->
            <div class="form-section bg-white p-4 rounded-md mb-6">
                <div class="section-header">
                    <i class="fas fa-lightbulb"></i> 客户需求
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="intention">
                        意向等级
                    </label>
                    <div class="relative">
                        <select id="intention" name="intention" class="block appearance-none w-full bg-white border border-gray-300 hover:border-gray-400 px-4 py-2 pr-8 rounded shadow leading-tight focus:outline-none focus:border-blue-500">
                            <option value="">请选择意向等级</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>
                    <p class="text-sm text-gray-500 mt-1" id="intention-description"></p>
                    <p class="text-sm text-gray-500 mt-1" id="intention-criteria"></p>
                    <p class="text-sm text-gray-500 mt-1" id="intention-priority"></p>
                </div>
                
                <div class="ios-form-group">
                    <label class="ios-form-label">预算范围</label>
                    <select id="budget" class="ios-form-input">
                        <option value="">请选择预算范围</option>
                        <option value="5万以下">5万以下</option>
                        <option value="5-20万">5-20万</option>
                        <option value="20-50万">20-50万</option>
                        <option value="50万以上">50万以上</option>
                    </select>
                    <p class="text-sm text-gray-500 mt-1" id="budget-description"></p>
                </div>
                
                <div class="ios-form-group mb-0">
                    <label class="ios-form-label">需求描述</label>
                    <textarea class="ios-form-input" rows="4"></textarea>
                </div>
            </div>
            
            <!-- 计划回访部分 -->
            <div class="form-section bg-white p-4 rounded-md mb-6">
                <div class="section-header">
                    <i class="fas fa-calendar-alt"></i> 计划回访
                </div>
                
                <div class="ios-form-group">
                    <label class="ios-form-label">计划回访时间</label>
                    <input type="datetime-local" id="plannedVisitDate" class="ios-form-input">
                </div>
                
                <div class="ios-form-group">
                    <label class="ios-form-label">计划回访方式</label>
                    <select id="plannedVisitMethod" class="ios-form-input">
                        <option value="">-- 请选择回访方式 --</option>
                        <!-- 回访方式将由JavaScript动态填充 -->
                    </select>
                    <p class="text-sm text-gray-500 mt-1" id="visit-method-description"></p>
                </div>
                
                <div class="ios-form-group mb-0">
                    <label class="ios-form-label">计划回访内容</label>
                    <textarea id="plannedVisitContent" class="ios-form-input" rows="3"></textarea>
                </div>
            </div>
            
            <!-- 关系网络部分 -->
            <div class="form-section bg-white p-4 rounded-md mb-6">
                <div class="section-header">
                    <i class="fas fa-project-diagram"></i> 关系网络
                </div>
                
                <div class="ios-form-group">
                    <label class="ios-form-label">上级联系人</label>
                    <select class="ios-form-input">
                        <option value="">无上级联系人</option>
                        <option value="1">王总 (ABC公司)</option>
                        <option value="2">李董 (XYZ公司)</option>
                        <option value="3">赵经理 (123公司)</option>
                    </select>
                </div>
                
                <div class="ios-form-group mb-0">
                    <label class="ios-form-label">下级联系人</label>
                    <select class="ios-form-input" multiple>
                        <option value="4">李经理</option>
                        <option value="5">赵主管</option>
                        <option value="6">钱助理</option>
                        <option value="7">孙职员</option>
                    </select>
                    <div class="text-xs text-gray-500 mt-1">按住Ctrl键可多选</div>
                </div>
            </div>
            
            <!-- 备注信息部分 -->
            <div class="form-section bg-white p-4 rounded-md mb-6">
                <div class="section-header">
                    <i class="fas fa-sticky-note"></i> 备注信息
                </div>
                
                <div class="ios-form-group mb-0">
                    <label class="ios-form-label">备注</label>
                    <textarea class="ios-form-input" rows="4"></textarea>
                </div>
            </div>
            
            <!-- 操作按钮区域优化：添加更多间距和更好的布局 -->
            <div class="flex flex-col items-center mb-24 px-4">
                <button id="saveBtn" type="button" class="ios-button-primary w-full mb-4 py-3 text-lg">
                    <i class="fas fa-save mr-2"></i>保存客户信息
                </button>
                
                <!-- 删除客户按钮 -->
                <button id="deleteBtn" type="button" class="ios-button-danger w-full py-3">
                    <i class="fas fa-trash-alt mr-2"></i>删除客户
                </button>
            </div>
        </div>
    </div>
    
    <script src="../js/app.js"></script>
    <script>
    // 从URL中获取客户ID
    function getCustomerIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('id');
    }
    
    // 加载客户分类
    async function loadCategories() {
        try {
            console.log('开始加载客户分类数据');
            const categories = await api.get('/customer-categories');
            const categorySelect = document.getElementById('category');
            
            if (!categorySelect) {
                console.error('未找到客户分类选择器');
                return [];
            }
            
            console.log('获取到客户分类数据:', categories);
            
            // 清空现有选项，保留默认选项
            while (categorySelect.options.length > 1) {
                categorySelect.remove(1);
            }
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id; // 使用ID作为值
                option.textContent = category.name;
                option.dataset.description = category.description;
                option.dataset.categoryId = category.id; // 存储分类ID
                categorySelect.appendChild(option);
            });

            // 监听分类选择变化
            categorySelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption && this.selectedIndex > 0) {
                    document.getElementById('category-description').textContent = 
                        selectedOption.dataset.description || '';
                } else {
                    document.getElementById('category-description').textContent = '';
                }
            });
            
            console.log('成功加载客户分类:', categories);
            return categories;
        } catch (error) {
            console.error('加载客户分类失败:', error);
            showToast('加载客户分类失败', 'error');
            return [];
        }
    }

    // 加载意向等级
    async function loadIntentions() {
        try {
            console.log('开始加载客户意向等级数据');
            const intentions = await api.get('/customer-intentions');
            const intentionSelect = document.getElementById('intention');
            
            if (!intentionSelect) {
                console.error('未找到意向等级选择器');
                return [];
            }
            
            console.log('获取到意向等级数据:', intentions);
            
            // 清空现有选项，保留默认选项
            while (intentionSelect.options.length > 1) {
                intentionSelect.remove(1);
            }
            
            intentions.forEach(intention => {
                const option = document.createElement('option');
                option.value = intention.level; // 使用level作为值
                option.textContent = `${intention.name} - ${intention.description}`;
                option.dataset.criteria = intention.criteria;
                option.dataset.priority = intention.followUpPriority;
                option.dataset.intentionId = intention.id; // 存储意向ID
                intentionSelect.appendChild(option);
            });

            // 监听意向等级选择变化
            intentionSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption && this.selectedIndex > 0) {
                    document.getElementById('intention-criteria').textContent = 
                        selectedOption.dataset.criteria ? `评估标准: ${selectedOption.dataset.criteria}` : '';
                    document.getElementById('intention-priority').textContent = 
                        selectedOption.dataset.priority ? `跟进优先级: ${selectedOption.dataset.priority}` : '';
                } else {
                    document.getElementById('intention-criteria').textContent = '';
                    document.getElementById('intention-priority').textContent = '';
                }
            });
            
            console.log('成功加载意向等级:', intentions);
            return intentions;
        } catch (error) {
            console.error('加载意向等级失败:', error);
            showToast('加载意向等级失败', 'error');
            return [];
        }
    }

    // 加载预算范围
    async function loadBudgetRanges() {
        try {
            console.log('开始加载预算范围数据');
            const budgetRanges = await api.get('/budget-ranges');
            const budgetSelect = document.getElementById('budget');
            
            if (!budgetSelect) {
                console.error('未找到预算范围选择器');
                return [];
            }
            
            console.log('获取到预算范围数据:', budgetRanges);
            
            // 清空现有选项，保留默认选项
            while (budgetSelect.options.length > 1) {
                budgetSelect.remove(1);
            }
            
            budgetRanges.forEach(budget => {
                const option = document.createElement('option');
                option.value = budget.id; // 使用ID作为值
                option.textContent = budget.name;
                option.dataset.budgetId = budget.id; // 存储预算ID
                budgetSelect.appendChild(option);
            });
            
            console.log('成功加载预算范围:', budgetRanges);
            return budgetRanges;
        } catch (error) {
            console.error('加载预算范围失败:', error);
            showToast('加载预算范围失败', 'error');
            return [];
        }
    }

    // 加载客户信息
    async function loadCustomerInfo(customerId) {
        try {
            console.log('开始加载客户信息，ID:', customerId);
            
            // 检查DOM是否已准备好
            if (!document.getElementById('category') || !document.getElementById('intention')) {
                console.warn('DOM尚未准备好，等待...');
                // 如果DOM未准备好，等待100ms后重试
                setTimeout(() => loadCustomerInfo(customerId), 100);
                return;
            }
            
            // 首先尝试从localStorage获取数据
            customer = await loadCustomerFromLocalStorage(customerId);
            
            if (!customer) {
                console.log('本地存储中没有找到客户数据，尝试从API获取');
                // 如果本地存储中没有，尝试从API获取
                try {
                    const response = await fetch(`/api/customers/${customerId}`);
                    if (!response.ok) {
                        throw new Error(`API返回错误: ${response.status}`);
                    }
                    customer = await response.json();
                } catch (apiError) {
                    console.warn('从API获取客户数据失败:', apiError);
                    showToast('无法加载客户数据，请稍后重试', 'error');
                    // 如果API获取失败，创建一个空客户对象
                    customer = { id: customerId };
                }
            }
            
            console.log('获取到客户数据:', customer);
            
            // 确保客户对象存在，即使是空的
            customer = customer || {};
            
            // 标准化字段名称
            if (customer.phoneNumber && !customer.phone) {
                customer.phone = customer.phoneNumber;
                console.log('已将phoneNumber映射到phone字段');
            } else if (customer.phone && !customer.phoneNumber) {
                customer.phoneNumber = customer.phone;
                console.log('已将phone映射到phoneNumber字段');
            }
            
            if (customer.wechatNumber && !customer.wechat) {
                customer.wechat = customer.wechatNumber;
                console.log('已将wechatNumber映射到wechat字段');
            } else if (customer.wechat && !customer.wechatNumber) {
                customer.wechatNumber = customer.wechat;
                console.log('已将wechat映射到wechatNumber字段');
            }
            
            console.log('标准化后的客户数据:', customer);
            
            // 等待预设数据加载完成
            await Promise.all([
                waitForDropdownOptions('category'),
                waitForDropdownOptions('intention')
            ]);
            
            console.log('预设数据已加载完成，现在设置表单字段值');
            // 设置表单字段值
            setFormValues();
            
        } catch (error) {
            console.error('加载客户信息时出错:', error);
            showToast('加载客户信息失败: ' + error.message, 'error');
        }
    }
    
    // 从localStorage获取客户数据
    async function loadCustomerFromLocalStorage(customerId) {
        try {
            const customersData = localStorage.getItem('customers');
            if (customersData) {
                const customers = JSON.parse(customersData);
                const customer = customers[customerId];
                console.log('从localStorage获取到客户数据:', customer);
                return customer;
            }
        } catch (error) {
            console.warn('从localStorage获取客户数据失败:', error);
        }
        return null;
    }
    
    // 等待下拉列表加载完成
    function waitForDropdownOptions(selectId) {
        return new Promise((resolve) => {
            const checkOptions = () => {
                const select = document.getElementById(selectId);
                if (select && select.options.length > 1) {
                    console.log(`${selectId}下拉列表已加载完成，选项数量:`, select.options.length);
                    resolve();
                } else {
                    console.log(`等待${selectId}下拉列表加载，当前选项数量:`, select?.options?.length || 0);
                    setTimeout(checkOptions, 100);
                }
            };
            checkOptions();
        });
    }
    
    // 设置表单字段值
    function setFormValues() {
        console.log('开始设置表单字段值，客户数据:', customer);
        console.log('客户数据字段:', Object.keys(customer).join(', '));
        
        // 尝试检测字段名格式
        if (customer.phone) {
            console.log('检测到使用phone字段');
        } else if (customer.phoneNumber) {
            console.log('检测到使用phoneNumber字段');
        }
        
        // 设置基本信息字段
        document.querySelector('input[type="text"]').value = customer.name || '';
        
        // 设置性别
        if (customer.gender) {
            const genderRadios = document.querySelectorAll('input[name="gender"]');
            genderRadios.forEach(radio => {
                if (radio.nextElementSibling && radio.nextElementSibling.textContent === customer.gender) {
                    radio.checked = true;
                }
            });
        }
        
        // 设置年龄
        document.querySelector('input[type="number"]').value = customer.age || '';
        
        // 设置注册日期
        if (customer.registrationDate) {
            try {
                // 尝试格式化日期为YYYY-MM-DD格式
                const date = new Date(customer.registrationDate);
                if (!isNaN(date.getTime())) {
                    const formattedDate = formatDateToISO(date);
                    document.querySelector('input[type="date"]').value = formattedDate;
                    console.log('设置注册日期:', formattedDate);
                } else {
                    console.warn('无法解析注册日期:', customer.registrationDate);
                    document.querySelector('input[type="date"]').value = '';
                }
            } catch (error) {
                console.error('格式化注册日期时出错:', error);
                document.querySelector('input[type="date"]').value = '';
            }
        } else {
            console.log('注册日期为空');
            document.querySelector('input[type="date"]').value = '';
        }
        
        // 设置联系方式
        document.querySelector('input[type="tel"]').value = customer.phone || customer.phoneNumber || '';
        document.querySelector('input[type="email"]').value = customer.email || '';
        document.querySelectorAll('input[type="text"]')[1].value = customer.wechat || customer.wechatNumber || '';
        
        // 设置地址信息
        document.querySelectorAll('input[type="text"]')[2].value = customer.address || '';
        
        // 设置备注
        document.querySelectorAll('textarea')[1].value = customer.remarks || '';
        
        // 设置客户分类
        const categorySelect = document.getElementById('category');
        const category = customer.category || '';
        const categoryName = customer.categoryName || '';
        const categoryId = customer.categoryId || '';
        
        if (category || categoryName || categoryId) {
            console.log('尝试匹配客户分类:', { category, categoryName, categoryId });
            
            Array.from(categorySelect.options).forEach(option => {
                if (option.value === category || 
                    option.value === categoryId ||
                    option.textContent === categoryName) {
                    option.selected = true;
                    console.log('找到匹配的客户分类:', option.textContent);
                    
                    // 触发change事件以更新描述
                    const event = new Event('change');
                    categorySelect.dispatchEvent(event);
                }
            });
        }
        
        // 设置客户意向
        const intentionSelect = document.getElementById('intention');
        const intention = customer.intention || '';
        const intentionName = customer.intentionName || '';
        const intentionId = customer.intentionId || '';
        const intentLevel = customer.intentLevel || '';
        
        if (intention || intentionName || intentionId || intentLevel) {
            console.log('尝试匹配客户意向:', { 
                intention, 
                intentionName, 
                intentionId,
                intentLevel 
            });
            
            let matched = false;
            
            // 先尝试精确匹配
            Array.from(intentionSelect.options).forEach(option => {
                if (!matched && (
                    option.value === intention || 
                    option.value === intentionId ||
                    option.value === intentLevel ||
                    option.dataset.intentionId === intentionId
                )) {
                    option.selected = true;
                    matched = true;
                    console.log('找到精确匹配的客户意向:', option.textContent);
                }
            });
            
            // 如果没有找到精确匹配，尝试文本包含匹配
            if (!matched && intentionName) {
                Array.from(intentionSelect.options).forEach(option => {
                    if (!matched && option.textContent.includes(intentionName)) {
                        option.selected = true;
                        matched = true;
                        console.log('找到文本匹配的客户意向:', option.textContent);
                    }
                });
            }
            
            // 触发change事件以更新描述
            if (matched) {
                const event = new Event('change');
                intentionSelect.dispatchEvent(event);
            } else {
                console.log('未找到匹配的意向等级');
            }
        } else {
            console.log('客户没有意向等级信息');
        }
        
        // 设置预算范围
        const budgetSelect = document.getElementById('budget');
        const budget = customer.budget || '';
        const budgetName = customer.budgetName || '';
        
        console.log('尝试匹配预算范围，客户数据:', customer);
        console.log('预算相关字段:', { 
            budget: customer.budget, 
            budgetName: customer.budgetName,
            budgetRange: customer.budgetRange,
            budgetAmount: customer.budgetAmount
        });
        
        let budgetToMatch = budget || budgetName || customer.budgetRange || customer.budgetAmount || '';
        
        if (!isNaN(parseInt(budgetToMatch))) {
            const amount = parseInt(budgetToMatch);
            if (amount < 50000) {
                budgetToMatch = '5万以下';
            } else if (amount < 200000) {
                budgetToMatch = '5-20万';
            } else if (amount < 500000) {
                budgetToMatch = '20-50万';
            } else {
                budgetToMatch = '50万以上';
            }
            console.log(`预算金额 ${amount} 转换为范围: ${budgetToMatch}`);
        }
        
        if (budgetToMatch) {
            let matched = false;
            
            Array.from(budgetSelect.options).forEach(option => {
                if (!matched && (option.value === budgetToMatch || 
                    option.textContent === budgetToMatch)) {
                    option.selected = true;
                    matched = true;
                    console.log('找到完全匹配的预算范围:', option.textContent);
                }
            });
            
            if (!matched) {
                Array.from(budgetSelect.options).forEach(option => {
                    if (!matched && (
                        budgetToMatch.includes(option.value) || 
                        option.value.includes(budgetToMatch) ||
                        budgetToMatch.includes(option.textContent) || 
                        option.textContent.includes(budgetToMatch))) {
                        option.selected = true;
                        matched = true;
                        console.log('找到部分匹配的预算范围:', option.textContent);
                    }
                });
            }
            
            if (!matched) {
                console.log('没有找到匹配的预算范围');
            }
        } else {
            console.log('没有提供预算范围信息');
        }
        
        // 设置地区
        const regionSelect = document.getElementById('region');
        const region = customer.region || '';
        const regionName = customer.regionName || '';
        
        console.log('尝试匹配地区，客户数据:', customer);
        console.log('地区相关字段:', { 
            region: customer.region, 
            regionName: customer.regionName, 
            address: customer.address 
        });
        
        let regionToMatch = region || regionName || '';
        if (!regionToMatch && customer.address) {
            const possibleRegions = ['上海', '北京', '广州', '深圳'];
            for (const r of possibleRegions) {
                if (customer.address.includes(r)) {
                    regionToMatch = r;
                    console.log(`从地址中提取到地区: ${r}`);
                    break;
                }
            }
        }
        
        if (regionToMatch) {
            let matched = false;
            Array.from(regionSelect.options).forEach(option => {
                if (!matched && (option.value === regionToMatch || 
                    option.textContent === regionToMatch)) {
                    option.selected = true;
                    matched = true;
                    console.log('找到完全匹配的地区:', option.textContent);
                }
            });
            
            if (!matched) {
                Array.from(regionSelect.options).forEach(option => {
                    if (!matched && (regionToMatch.includes(option.value) || 
                        option.value.includes(regionToMatch) ||
                        regionToMatch.includes(option.textContent) || 
                        option.textContent.includes(regionToMatch))) {
                        option.selected = true;
                        matched = true;
                        console.log('找到部分匹配的地区:', option.textContent);
                    }
                });
            }
            
            if (!matched && customer.address) {
                const otherOption = Array.from(regionSelect.options).find(opt => opt.value === '其他');
                if (otherOption) {
                    otherOption.selected = true;
                    console.log('没有找到匹配的地区，选择"其他"');
                }
            }
        } else {
            console.log('没有提供地区信息');
        }
        
        // 设置上级联系人
        const superiorSelect = document.querySelectorAll('select')[3];
        const superior = customer.superiorContact || '';
        
        if (superior) {
            console.log('尝试匹配上级联系人:', { superiorContact: superior });
            
            Array.from(superiorSelect.options).forEach(option => {
                if (option.value === superior || 
                    option.textContent === superior) {
                    option.selected = true;
                    console.log('找到匹配的上级联系人:', option.textContent);
                }
            });
        }
        
        // 设置下级联系人
        const subordinateSelect = document.querySelectorAll('select')[4];
        const subordinates = customer.subordinates || [];
        
        if (subordinates.length > 0) {
            console.log('尝试匹配下级联系人:', { subordinates });
            
            subordinates.forEach(subordinate => {
                const option = document.createElement('option');
                option.value = subordinate;
                option.textContent = subordinate;
                subordinateSelect.appendChild(option);
            });
        }
        
        // 设置计划回访字段
        if (customer.planned_visit_date) {
            document.getElementById('plannedVisitDate').value = formatDateForDatetimeInput(customer.planned_visit_date);
        } else {
            // 如果没有计划回访时间，设置默认值（当前时间+1个月）
            setDefaultPlannedVisitDate();
        }
        
        // 设置计划回访内容
        document.getElementById('plannedVisitContent').value = customer.planned_visit_content || '';
        
        // 设置回访方式下拉选项
        setVisitMethodSelection();
        
        // 马上设置地区和预算下拉列表
        setRegionSelection();
        setBudgetSelection();
        
        // 马上设置地区、预算范围和客户意向下拉列表
        setRegionSelection();
        setBudgetSelection();
        handleIntentionSelection();
        
        // 马上设置地区、预算范围和客户意向下拉列表
        setRegionSelection();
        setBudgetSelection();
        handleIntentionSelection();

        // 设置地区、预算范围和客户意向
        setRegionSelection();
        setBudgetSelection();
        handleIntentionSelection();
    }
    
    // 将日期字符串格式化为datetime-local输入框可接受的格式
    function formatDateForDatetimeInput(dateString) {
        // 尝试解析日期字符串
        const date = new Date(dateString);
        if (isNaN(date.getTime())) {
            console.error('无效的日期格式:', dateString);
            return '';
        }
        
        // 格式化为YYYY-MM-DDThh:mm
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    }
    
    // 设置回访方式下拉选项
    function setVisitMethodSelection() {
        const visitMethod = customer.planned_visit_method || '';
        
        if (visitMethod) {
            const methodSelect = document.getElementById('plannedVisitMethod');
            console.log('尝试匹配回访方式:', visitMethod);
            
            Array.from(methodSelect.options).forEach(option => {
                if (option.value === visitMethod || 
                    option.textContent === visitMethod) {
                    option.selected = true;
                    console.log('找到匹配的回访方式:', option.textContent);
                }
            });
        }
    }
    
    // 设置表单提交事件
    function setupFormSubmission(customerId) {
        const saveBtn = document.getElementById('saveBtn');
        const headerSaveBtn = document.getElementById('headerSaveBtn');
        
        const saveHandler = async function() {
            try {
                const formData = collectFormData();
                
                // 添加必要的额外字段
                formData.id = customerId;
                
                console.log('准备保存客户数据:', formData);
                
                // 显示保存中状态
                this.disabled = true;
                const originalText = this.innerText;
                this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>保存中...';
                
                // 发送到服务器
                const response = await api.put(`/customers/${customerId}`, formData);
                
                // 检查API响应
                console.log('API响应数据:', response);
                
                // 显示成功消息
                console.log('客户数据保存成功:', response);
                showToast('保存成功！', 'success');
                
                // 确保使用一致的字段名保存到localStorage
                const normalizedData = {
                    ...formData,
                    phone: formData.phone,
                    phoneNumber: formData.phone, // 同时保存两种格式以兼容
                    wechat: formData.wechat,
                    wechatNumber: formData.wechat // 同时保存两种格式以兼容
                };
                
                // 可选：缓存客户数据到localStorage
                saveCustomerToLocalStorage(customerId, normalizedData);
                
                // 延迟跳转，给用户足够时间看到成功消息
                setTimeout(() => {
                    window.location.href = `customer-detail.html?id=${customerId}`;
                }, 1000);
            } catch (error) {
                console.error('保存客户数据失败:', error);
                showToast('保存失败: ' + error.message, 'error');
                
                // 恢复按钮状态
                this.disabled = false;
                this.innerText = originalText;
            }
        };
        
        saveBtn.addEventListener('click', saveHandler);
        headerSaveBtn.addEventListener('click', saveHandler);
    }
    
    // 收集表单数据
    function collectFormData() {
        // 基本信息
        const name = document.querySelector('input[type="text"]').value.trim();
        
        // 性别
        let gender = '';
        const genderRadios = document.querySelectorAll('input[name="gender"]');
        genderRadios.forEach(radio => {
            if (radio.checked && radio.nextElementSibling) {
                gender = radio.nextElementSibling.textContent;
            }
        });
        
        // 年龄
        const age = document.querySelector('input[type="number"]').value;
        
        // 注册日期
        const registrationDate = document.querySelector('input[type="date"]').value;
        
        // 联系方式
        const phone = document.querySelector('input[type="tel"]').value.trim();
        const email = document.querySelector('input[type="email"]').value.trim();
        const wechat = document.querySelectorAll('input[type="text"]')[1].value.trim();
        
        // 地址信息
        const regionSelect = document.getElementById('region');
        const region = regionSelect.value;
        const address = document.querySelectorAll('input[type="text"]')[2].value.trim();
        
        // 客户分类
        const categorySelect = document.getElementById('category');
        const category = categorySelect.value;
        
        // 客户意向
        const intentionSelect = document.getElementById('intention');
        const intention = intentionSelect.value;
        
        // 预算范围
        const budgetSelect = document.getElementById('budget');
        const budget = budgetSelect.value;
        
        // 需求描述
        const demand = document.querySelectorAll('textarea')[0].value.trim();
        
        // 上级联系人
        const superiorSelect = document.querySelectorAll('select')[3];
        const superior = superiorSelect.value;
        
        // 备注
        const remark = document.querySelectorAll('textarea')[1].value.trim();
        
        // 计划回访
        const plannedVisitDate = document.getElementById('plannedVisitDate').value;
        const plannedVisitMethod = document.getElementById('plannedVisitMethod').value;
        const plannedVisitContent = document.getElementById('plannedVisitContent').value.trim();
        
        return {
            name,
            gender,
            age,
            registrationDate,
            phone,
            email,
            wechat,
            region,
            address,
            category,
            intention,
            budget,
            demand,
            superior,
            remark,
            planned_visit_date: plannedVisitDate,
            planned_visit_method: plannedVisitMethod,
            planned_visit_content: plannedVisitContent
        };
    }

    // 设置预算范围下拉列表
    function setBudgetSelection() {
        const budget = customer.budget || '';
        const budgetName = customer.budgetName || '';
        const budgetId = customer.budgetId || '';
        
        console.log('尝试匹配预算范围，客户数据:', customer);
        console.log('预算相关字段:', { 
            budget: customer.budget, 
            budgetName: customer.budgetName,
            budgetRange: customer.budgetRange,
            budgetAmount: customer.budgetAmount,
            budgetId: customer.budgetId
        });
        
        const budgetSelect = document.getElementById('budget');
        if (!budgetSelect) {
            console.error('无法找到预算范围下拉列表元素');
            return;
        }
        
        // 尝试多种可能的字段名
        let budgetToMatch = budget || budgetName || customer.budgetRange || customer.budgetAmount || '';
        
        // 如果是数字，转换为范围文本
        if (!isNaN(parseInt(budgetToMatch))) {
            const amount = parseInt(budgetToMatch);
            if (amount < 50000) {
                budgetToMatch = '5万以下';
            } else if (amount < 200000) {
                budgetToMatch = '5-20万';
            } else if (amount < 500000) {
                budgetToMatch = '20-50万';
            } else {
                budgetToMatch = '50万以上';
            }
            console.log(`预算金额 ${amount} 转换为范围: ${budgetToMatch}`);
        }
        
        if (budgetToMatch || budgetId) {
            let matched = false;
            
            // 先尝试通过ID匹配
            if (budgetId) {
                Array.from(budgetSelect.options).forEach(option => {
                    if (!matched && (
                        option.value === budgetId ||
                        option.dataset.budgetId === budgetId
                    )) {
                        option.selected = true;
                        matched = true;
                        console.log('通过ID找到匹配的预算范围:', option.textContent);
                    }
                });
            }
            
            // 尝试完全匹配
            if (!matched && budgetToMatch) {
                Array.from(budgetSelect.options).forEach(option => {
                    if (!matched && (option.value === budgetToMatch || 
                        option.textContent === budgetToMatch)) {
                        option.selected = true;
                        matched = true;
                        console.log('找到完全匹配的预算范围:', option.textContent);
                    }
                });
            }
            
            // 如果没有完全匹配，尝试部分匹配
            if (!matched && budgetToMatch) {
                Array.from(budgetSelect.options).forEach(option => {
                    if (!matched && (
                        budgetToMatch.includes(option.value) || 
                        option.value.includes(budgetToMatch) ||
                        budgetToMatch.includes(option.textContent) || 
                        option.textContent.includes(budgetToMatch))) {
                        option.selected = true;
                        matched = true;
                        console.log('找到部分匹配的预算范围:', option.textContent);
                    }
                });
            }
            
            // 触发change事件以更新相关UI
            if (matched) {
                const event = new Event('change');
                budgetSelect.dispatchEvent(event);
            } else {
                console.log('没有找到匹配的预算范围');
            }
        } else {
            console.log('没有提供预算范围信息');
        }
    }
    
    // 设置地区下拉列表
    function setRegionSelection() {
        const region = customer.region || '';
        const regionName = customer.regionName || '';
        
        console.log('尝试匹配地区，客户数据:', customer);
        console.log('地区相关字段:', { 
            region: customer.region, 
            regionName: customer.regionName, 
            address: customer.address 
        });
        
        const regionSelect = document.getElementById('region');
        if (!regionSelect) {
            console.error('无法找到地区下拉列表元素');
            return;
        }
        
        // 如果没有明确的地区值，尝试从地址中提取
        let regionToMatch = region || regionName || '';
        if (!regionToMatch && customer.address) {
            // 尝试从地址中提取地区（简单匹配前缀）
            const possibleRegions = ['上海', '北京', '广州', '深圳'];
            for (const r of possibleRegions) {
                if (customer.address.includes(r)) {
                    regionToMatch = r;
                    console.log(`从地址中提取到地区: ${r}`);
                    break;
                }
            }
        }
        
        if (regionToMatch) {
            let matched = false;
            // 尝试完全匹配
            Array.from(regionSelect.options).forEach(option => {
                if (!matched && (option.value === regionToMatch || 
                    option.textContent === regionToMatch)) {
                    option.selected = true;
                    matched = true;
                    console.log('找到完全匹配的地区:', option.textContent);
                }
            });
            
            // 如果没有完全匹配，尝试部分匹配
            if (!matched) {
                Array.from(regionSelect.options).forEach(option => {
                    if (!matched && (regionToMatch.includes(option.value) || 
                        option.value.includes(regionToMatch) ||
                        regionToMatch.includes(option.textContent) || 
                        option.textContent.includes(regionToMatch))) {
                        option.selected = true;
                        matched = true;
                        console.log('找到部分匹配的地区:', option.textContent);
                    }
                });
            }
            
            // 如果仍然没有匹配，选择"其他"
            if (!matched && customer.address) {
                const otherOption = Array.from(regionSelect.options).find(opt => opt.value === '其他');
                if (otherOption) {
                    otherOption.selected = true;
                    console.log('没有找到匹配的地区，选择"其他"');
                }
            }
        } else {
            console.log('没有提供地区信息');
        }
    }
    
    // 设置上级联系人下拉列表
    function setSuperiorContactSelection() {
        const superiorContact = customer.superiorContact || '';
        
        if (superiorContact) {
            const contactSelect = document.querySelectorAll('select')[3];
            console.log('尝试匹配上级联系人:', { superiorContact });
            
            Array.from(contactSelect.options).forEach(option => {
                if (option.value === superiorContact || 
                    option.textContent === superiorContact) {
                    option.selected = true;
                    console.log('找到匹配的上级联系人:', option.textContent);
                }
            });
        }
    }

    // 设置客户分类下拉选项
    function handleCategorySelection() {
        const category = customer.category || '';
        const categoryName = customer.categoryName || '';
        const categoryId = customer.categoryId || '';
        
        if (category || categoryName || categoryId) {
            const categorySelect = document.getElementById('category');
            console.log('尝试匹配客户分类:', { category, categoryName, categoryId });
            
            Array.from(categorySelect.options).forEach(option => {
                if (option.value === category || 
                    option.value === categoryId ||
                    option.textContent === categoryName) {
                    option.selected = true;
                    console.log('找到匹配的客户分类:', option.textContent);
                    
                    // 触发change事件以更新描述
                    const event = new Event('change');
                    categorySelect.dispatchEvent(event);
                }
            });
        }
    }
    
    // 设置客户意向下拉选项
    function handleIntentionSelection() {
        const intention = customer.intention || '';
        const intentionName = customer.intentionName || '';
        const intentionId = customer.intentionId || '';
        
        if (intention || intentionName || intentionId) {
            const intentionSelect = document.getElementById('intention');
            console.log('尝试匹配客户意向:', { intention, intentionName, intentionId });
            
            Array.from(intentionSelect.options).forEach(option => {
                if (option.value === intention || 
                    option.value === intentionId ||
                    option.textContent.includes(intentionName)) {
                    option.selected = true;
                    console.log('找到匹配的客户意向:', option.textContent);
                    
                    // 触发change事件以更新描述
                    const event = new Event('change');
                    intentionSelect.dispatchEvent(event);
                }
            });
        }
    }

    // 页面加载完成后的初始化
    document.addEventListener('DOMContentLoaded', async function() {
        try {
            console.log('页面DOM加载完成，开始初始化');
            
            // 获取客户ID
            const customerId = getCustomerIdFromUrl();
            console.log('从URL获取到客户ID:', customerId);
            
            // 加载预设数据
            await loadPresetData();
            
            // 注册事件处理程序
            registerEventHandlers();
            
            // 加载回访方式数据
            await loadVisitMethods();
            
            // 如果有客户ID，加载客户信息
            if (customerId) {
                console.log('开始加载现有客户信息');
                loadCustomerInfo(customerId);
                
                // 设置表单提交事件
                setupFormSubmission(customerId);
                
                // 增加删除按钮功能
                const deleteBtn = document.getElementById('deleteBtn');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', function() {
                        showDeleteConfirmDialog(customerId);
                    });
                    
                    // 显示删除按钮
                    deleteBtn.classList.remove('hidden');
                }
            } else {
                console.log('新客户，设置默认值');
                // 设置默认的注册日期为今天
                const today = formatDateToISO(new Date());
                document.querySelector('input[type="date"]').value = today;
                console.log('设置默认注册日期:', today);
                
                // 设置默认计划回访日期（一个月后）
                setDefaultPlannedVisitDate();
                
                // 设置空客户对象
                customer = {};
                
                // 设置表单提交事件（使用临时ID）
                setupFormSubmission('new' + Date.now());
            }
            
            // 显示页面内容
            document.querySelector('.ios-page-container').classList.remove('hidden');
        } catch (error) {
            console.error('初始化页面失败:', error);
            showError('页面加载失败，请刷新页面重试');
        }
    });

    // 加载回访方式数据
    async function loadVisitMethods() {
        try {
            const methods = await api.get('/visit-methods');
            updateVisitMethodsDropdown(methods);
            
            // 缓存回访方式数据
            localStorage.setItem('visitMethods', JSON.stringify(methods));
            console.log('回访方式数据已缓存');
            
            return methods;
        } catch (error) {
            console.error('加载回访方式数据失败:', error);
            
            // 尝试从缓存加载
            const visitMethodsCache = localStorage.getItem('visitMethods');
            if (visitMethodsCache) {
                console.log('使用缓存的回访方式数据');
                updateVisitMethodsDropdown(JSON.parse(visitMethodsCache));
            }
            
            throw error;
        }
    }
    
    // 更新回访方式下拉列表
    function updateVisitMethodsDropdown(methods) {
        try {
            const methodSelect = document.getElementById('plannedVisitMethod');
            
            // 清空现有选项，保留默认选项
            while (methodSelect.options.length > 1) {
                methodSelect.remove(1);
            }
            
            // 添加回访方式选项
            methods.forEach(method => {
                const option = document.createElement('option');
                option.value = method.name;
                option.textContent = method.name;
                option.dataset.description = method.description;
                methodSelect.appendChild(option);
            });
        } catch (error) {
            console.error('更新回访方式下拉列表失败:', error);
        }
    }
    
    // 设置默认计划回访时间（当前时间+1个月）
    function setDefaultPlannedVisitDate() {
        const plannedVisitDateInput = document.getElementById('plannedVisitDate');
        
        // 如果已经有值，则不设置默认值
        if (plannedVisitDateInput.value) {
            return;
        }
        
        // 获取当前时间
        const now = new Date();
        
        // 计算一个月后的日期
        const nextMonth = new Date(now);
        nextMonth.setMonth(now.getMonth() + 1);
        
        // 格式化日期
        const year = nextMonth.getFullYear();
        const month = String(nextMonth.getMonth() + 1).padStart(2, '0');
        const day = String(nextMonth.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        
        // 设置默认值为一个月后的同一时间
        const formattedDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
        plannedVisitDateInput.value = formattedDateTime;
    }

    // 使用localStorage保存客户数据
    function saveCustomerToLocalStorage(customerId, customerData) {
        try {
            // 获取现有的客户列表
            let customersData = localStorage.getItem('customers');
            let customers = customersData ? JSON.parse(customersData) : {};
            
            // 更新或添加客户数据
            customers[customerId] = { 
                ...customerData, 
                id: customerId, 
                lastUpdated: new Date().toISOString() 
            };
            
            // 保存回localStorage
            localStorage.setItem('customers', JSON.stringify(customers));
            console.log(`客户数据已保存到本地存储，ID: ${customerId}`);
            
            // 同时更新客户列表
            updateCustomersList(customerId, customerData);
            
            return customerId;
        } catch (error) {
            console.error('保存到本地存储失败:', error);
            throw error;
        }
    }
    
    // 更新客户列表
    function updateCustomersList(customerId, customerData) {
        try {
            // 获取现有的客户列表
            let customersList = localStorage.getItem('customersList');
            let customers = customersList ? JSON.parse(customersList) : [];
            
            // 查找客户在列表中的索引
            const index = customers.findIndex(c => c.id === customerId);
            
            // 构建列表项数据
            const customerItem = {
                id: customerId,
                name: customerData.name,
                phone: customerData.phone || customerData.phoneNumber || '',
                category: customerData.categoryName || customerData.category || '',
                intention: customerData.intentionName || customerData.intention || '',
                lastUpdated: new Date().toISOString()
            };
            
            // 更新或添加客户到列表
            if (index >= 0) {
                customers[index] = customerItem;
            } else {
                customers.push(customerItem);
            }
            
            // 保存回localStorage
            localStorage.setItem('customersList', JSON.stringify(customers));
            console.log('客户列表已更新');
        } catch (error) {
            console.error('更新客户列表失败:', error);
            // 不抛出错误，因为这只是辅助功能
        }
    }

    // 显示删除确认对话框
    function showDeleteConfirmDialog(customerId) {
        // 创建确认对话框
        const dialog = document.createElement('div');
        dialog.className = 'delete-confirm-dialog';
        dialog.innerHTML = `
            <div class="delete-confirm-content">
                <div class="delete-confirm-title">确认删除</div>
                <div class="delete-confirm-message">
                    确定要删除此客户吗？此操作将删除该客户的所有相关数据，且不可恢复。
                </div>
                <div class="delete-confirm-buttons">
                    <button class="delete-confirm-cancel">取消</button>
                    <button class="delete-confirm-delete">删除</button>
                </div>
            </div>
        `;
        
        // 添加到页面
        document.body.appendChild(dialog);
        
        // 设置按钮事件
        const cancelBtn = dialog.querySelector('.delete-confirm-cancel');
        const confirmBtn = dialog.querySelector('.delete-confirm-delete');
        
        // 取消按钮
        cancelBtn.addEventListener('click', () => {
            document.body.removeChild(dialog);
        });
        
        // 确认删除按钮
        confirmBtn.addEventListener('click', () => {
            deleteCustomer(customerId);
            document.body.removeChild(dialog);
        });
    }
    
    // 删除客户
    async function deleteCustomer(customerId) {
        try {
            // 显示加载状态
            showToast('正在删除...', 'info');
            
            // 调用API删除客户
            const response = await fetch(`/api/customers/${customerId}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) {
                throw new Error(`删除失败: ${response.status}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                showToast('客户已成功删除', 'success');
                
                // 删除成功后跳转到客户列表页面
                setTimeout(() => {
                    window.location.href = '/pages/customer-list.html';
                }, 1000);
            } else {
                throw new Error(result.error || '删除失败');
            }
        } catch (error) {
            console.error('删除客户失败:', error);
            showToast(`删除失败: ${error.message}`, 'error');
        }
    }
    
    // 注册各种事件处理程序
    function registerEventHandlers() {
        console.log('注册事件处理程序');
        
        // 处理分类下拉框变化
        const categorySelect = document.getElementById('category');
        if (categorySelect) {
            categorySelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const description = selectedOption.dataset.description || '';
                document.getElementById('category-description').textContent = description;
            });
        }
        
        // 处理意向下拉框变化
        const intentionSelect = document.getElementById('intention');
        if (intentionSelect) {
            intentionSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const description = selectedOption.dataset.description || '';
                document.getElementById('intention-description').textContent = description;
            });
        }
        
        // 处理预算下拉框变化
        const budgetSelect = document.getElementById('budget');
        if (budgetSelect) {
            budgetSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const description = selectedOption.dataset.description || '';
                if (document.getElementById('budget-description')) {
                    document.getElementById('budget-description').textContent = description;
                }
            });
        }
        
        // 处理回访方式下拉框变化
        const visitMethodSelect = document.getElementById('plannedVisitMethod');
        if (visitMethodSelect) {
            visitMethodSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const description = selectedOption.dataset.description || '';
                if (document.getElementById('visit-method-description')) {
                    document.getElementById('visit-method-description').textContent = description;
                }
            });
        }
    }
    
    // 显示错误信息
    function showError(message) {
        showToast(message, 'error');
    }
    
    // 显示Toast提示
    function showToast(message, type = 'info') {
        // 如果已经存在Toast，先移除
        const existingToast = document.querySelector('.toast');
        if (existingToast) {
            document.body.removeChild(existingToast);
        }
        
        // 创建新的Toast
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        
        // 添加到页面
        document.body.appendChild(toast);
        
        // 显示Toast
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);
        
        // 设置自动关闭
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 500);
        }, 3000);
    }

    // 加载预设数据
    async function loadPresetData() {
        try {
            console.log('开始加载预设数据');
            // 并行加载所有预设数据以提高效率
            await Promise.all([
                loadCategories(),
                loadIntentions(),
                loadBudgetRanges()
            ]);
            console.log('所有预设数据加载完成');
        } catch (error) {
            console.error('加载预设数据失败:', error);
            showToast('加载预设数据失败，部分信息可能无法正确显示', 'error');
        }
    }

    // 设置默认注册日期（如果没有提供）
    function setDefaultRegistrationDate() {
        const dateInput = document.querySelector('input[type="date"]');
        if (!dateInput.value) {
            // 设置为今天
            const today = formatDateToISO(new Date());
            dateInput.value = today;
            console.log('设置默认注册日期:', today);
        }
    }
    </script>
</body>
</html>